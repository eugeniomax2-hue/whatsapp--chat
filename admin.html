<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Contatos captados</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:20px;background:#f8fafc;color:#0f172a}
    h1{margin:0 0 10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
    input[type=url]{min-width:360px;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    button{background:#0ea5e9;color:#fff;border:0;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:#e2e8f0;color:#0f172a}
    button.danger{background:#ef4444}
    table{border-collapse:collapse;width:100%;background:#fff;border:1px solid #e2e8f0}
    th,td{padding:10px;border-bottom:1px solid #e2e8f0;font-size:14px}
    th{background:#f1f5f9;text-align:left}
  </style>
</head>
<body>
  <h1>Admin — Contatos</h1>
  <div>Configure abaixo o <b>endpoint</b> (Google Apps Script Web App). Ele ficará salvo no seu navegador.</div>
  <div class="row">
    <input id="api" type="url" placeholder="https://script.google.com/macros/s/XXX/exec" />
    <button id="save">Guardar</button>
    <button id="load" class="secondary">Atualizar lista</button>
    <button id="exportCsv">Exportar CSV</button>
    <button id="exportJson" class="secondary">Exportar JSON</button>
  </div>

  <table id="tbl">
    <thead><tr><th>#</th><th>Telefone</th><th>Captado em (ISO)</th></tr></thead>
    <tbody></tbody>
  </table>

<script>
  const key='api_url';
  const input=document.getElementById('api');
  const tbody=document.querySelector('#tbl tbody');

  input.value=localStorage.getItem(key)||'';

  document.getElementById('save').onclick=()=>{
    if(!input.value){ alert('Informe a URL do Web App do Apps Script'); return; }
    localStorage.setItem(key, input.value);
    alert('Endpoint guardado!');
  };

  document.getElementById('load').onclick=load;

  function toCSV(arr){
    const header = ["phone","ts"];
    const lines = [header.join(",")].concat(arr.map(c=>[c.phone||"", c.ts||""].map(x=>`"${(x||"").replaceAll('"','""')}"`).join(",")));
    return lines.join("\n");
  }

  document.getElementById('exportCsv').onclick=()=>{
    const rows = Array.from(tbody.querySelectorAll('tr')).map(tr=>{
      const tds=tr.querySelectorAll('td'); return {phone:tds[1].textContent, ts:tds[2].textContent};
    });
    if(!rows.length){ alert('Liste primeiro (Atualizar)'); return; }
    const blob = new Blob([toCSV(rows)], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'),{href:url,download:'contatos.csv'});
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };

  document.getElementById('exportJson').onclick=()=>{
    const rows = Array.from(tbody.querySelectorAll('tr')).map(tr=>{
      const tds=tr.querySelectorAll('td'); return {phone:tds[1].textContent, ts:tds[2].textContent};
    });
    if(!rows.length){ alert('Liste primeiro (Atualizar)'); return; }
    const blob = new Blob([JSON.stringify(rows,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'),{href:url,download:'contatos.json'});
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };

  async function load(){
    const api = input.value.trim();
    if(!api){ alert('Configure o endpoint primeiro'); return; }
    tbody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';
    try{
      const res = await fetch(api + (api.includes('?')?'&':'?') + 'list=1');
      const data = await res.json();
      tbody.innerHTML='';
      (data.rows||[]).forEach((c,i)=>{ 
        const tr=document.createElement('tr'); 
        tr.innerHTML = `<td>${i+1}</td><td>${c.phone||''}</td><td>${c.ts||''}</td>`; 
        tbody.appendChild(tr);
      });
      if(!tbody.children.length){ tbody.innerHTML='<tr><td colspan="3">Sem dados ainda</td></tr>'; }
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="3">Erro ao buscar: ${e}</td></tr>`;
    }
  }
</script>
</body>
</html>
